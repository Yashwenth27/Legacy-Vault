// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// 1. REVENUE & TIERS
// --------------------------------------

enum PlanTier {
  FREE      // Limit: 1 Nominee, 3 Vault Items
  DIAMOND   // Limit: Unlimited Nominees, Unlimited Vault Items
}

// --------------------------------------
// 2. THE USER (The Vault Owner)
// --------------------------------------

model User {
  id              String    @id @default(uuid())
  email           String    @unique // For Email Heartbeats
  phone           String?   @unique // For WhatsApp Heartbeats (Optional but needed for 'Both')
  
  passwordHash    String    // For login (NOT for encryption)
  
  // Subscription Logic
  plan            PlanTier  @default(FREE)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // --------------------------------------
  // 3. THE HEARTBEAT ENGINE
  // --------------------------------------
  
  lastHeartbeat   DateTime  @default(now()) // Updated via WhatsApp OR Email response
  
  // Configuration
  checkInInterval Int       @default(30)    // How often to ask "Are you alive?" (Days)
  gracePeriodDays Int       @default(7)     // How long to wait after a missed check-in before releasing
  
  // Status
  isDead          Boolean   @default(false) // The Trigger status
  deadConfirmedAt DateTime?                 // When the system officially marked them dead

  // Relations
  vaultItems      VaultItem[]
  nominees        Nominee[]
  auditLogs       HeartbeatLog[] // To track history of responses
}

// --------------------------------------
// 4. THE NOMINEES (Beneficiaries)
// --------------------------------------

model Nominee {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  name            String
  email           String
  phone           String    // For notifying them
  
  // Priority allows a "Chain of Command" (e.g., Ask Wife first, if fails, ask Brother)
  // Or simply notify all at once.
  relationship    String    // e.g., "Spouse", "Son"
  
  accessGranted   Boolean   @default(false)
  magicLinkToken  String?   @unique // generated only after User.isDead = true
}

// --------------------------------------
// 5. THE VAULT (Encrypted Assets)
// --------------------------------------

model VaultItem {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  name          String
  mimeType      String   @default("text/plain") 
  encryptedBlob String   
  iv            String   
  createdAt     DateTime @default(now())
}

// --------------------------------------
// 6. LOGS (For Audit / Safety)
// --------------------------------------

model HeartbeatLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  respondedAt DateTime @default(now())
  method      String   // "WHATSAPP" or "EMAIL" - tracks which one they clicked
}